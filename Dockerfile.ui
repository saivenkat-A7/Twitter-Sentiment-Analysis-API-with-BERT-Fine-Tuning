# ── Stage 1: Builder ──────────────────────────────────────────────────────────
FROM python:3.11-slim AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
        gcc \
        curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /wheels

COPY requirements.ui.txt .

# Pre-compile wheels — cached layer, only re-runs when requirements change
RUN pip wheel --no-cache-dir --wheel-dir /wheels/dist \
        -r requirements.ui.txt


# ── Stage 2: Runtime ──────────────────────────────────────────────────────────
FROM python:3.11-slim AS runtime

RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

WORKDIR /app

# Install from pre-built wheels — fast, no network calls at runtime
COPY --from=builder /wheels/dist /wheels/dist
RUN pip install --no-cache-dir --no-index \
        --find-links=/wheels/dist \
        streamlit requests pandas matplotlib \
    && rm -rf /wheels/dist \
    && pip cache purge

# Copy only the UI source file
COPY src/ui.py ./src/ui.py

# Pre-create results dir (mounted as volume at runtime)
RUN mkdir -p results

# ── Streamlit config for fastest cold start ───────────────────────────────────
# Write config file instead of passing CLI flags — cleaner and parsed faster
RUN mkdir -p /root/.streamlit
COPY <<EOF /root/.streamlit/config.toml
[server]
port = 8501
address = "0.0.0.0"
headless = true
enableCORS = false
enableXsrfProtection = false

[browser]
gatherUsageStats = false

[runner]
# Disable file watcher — not needed in production, saves CPU + startup time
fastReruns = true

[global]
# Suppress the welcome/first-run message
showWarningOnDirectExecution = false
EOF

# ── Environment ───────────────────────────────────────────────────────────────
ENV API_URL=http://api:8000 \
    RESULTS_DIR=/app/results \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONOPTIMIZE=1

EXPOSE 8501 

# Healthcheck — short start_period, UI starts in seconds
HEALTHCHECK --interval=15s --timeout=5s --start-period=20s --retries=5 \
    CMD curl -sf http://localhost:8501/_stcore/health || exit 1

CMD ["streamlit", "run", "src/ui.py"]

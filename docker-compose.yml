version: "3.9"



services:

  #  FastAPI Prediction Service 
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    image: ghcr.io/saivenkat-a7/app-api:latest
    container_name: sentiment_api
    env_file: .env
    environment:
      MODEL_PATH:         ${MODEL_PATH:-/app/model_output}
      MODEL_OUTPUT:       ${MODEL_OUTPUT:-/app/model_output}
      API_PORT:           ${API_PORT:-8000}
      MAX_LEN:            ${MAX_LEN:-128}
      PROCESSED_DATA_DIR: ${PROCESSED_DATA_DIR:-/app/data/processed}
      RESULTS_DIR:        ${RESULTS_DIR:-/app/results}
      BATCH_SIZE:         ${BATCH_SIZE:-10}
      NUM_EPOCHS:         ${NUM_EPOCHS:-2}
      SAMPLE_SIZE:        ${SAMPLE_SIZE:-}
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - model_data:/app/model_output      # trained model persists across restarts
      - results_data:/app/results         # metrics persist across restarts
      - processed_data:/app/data/processed # preprocessed CSVs persist
    restart: unless-stopped
    healthcheck:
      test:         ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval:     30s
      timeout:      10s
      retries:      3
      start_period: 1800s   # 30 min — covers full preprocess + train on CPU

  # ── Streamlit Web Interface ───────────────────────────────────────────────
  ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    image: ghcr.io/saivenkat-a7/app-ui:latest
    container_name: sentiment_ui
    env_file: .env
    environment:
      API_URL:     http://api:${API_PORT:-8000}
      RESULTS_DIR: /app/results
    ports:
      - "${UI_PORT:-8501}:8501"
    volumes:
      - results_data:/app/results:ro      # read-only: display training metrics
    depends_on:
      api:
        condition: service_healthy        # UI only starts after API is ready
    restart: unless-stopped
    healthcheck:
      test:         ["CMD", "curl", "-sf", "http://localhost:8501/_stcore/health"]
      interval:     15s
      timeout:      5s
      retries:      5
      start_period: 20s

# ── Named Volumes ─────────────────────────────────────────────────────────────
# Data survives container restarts — no retraining needed on docker-compose restart
volumes:
  model_data:
  results_data:
  processed_data:
